# 计算机系统漫游

## 信息构成

+ 文本文件：全部由ASCII字符构成。
+ 二进制文件：除文本文件的其他文件。

```c
#include <stdio.h>

int main()
{
    printf("hello,world\n");
    return 0;
}
```

## 程序翻译流程

以C语言程序为例。

+ 预处理cpp：c->i，文本->文本。插入#include <stdio.h>头文件。
+ 编译ccl：i->s，文本->文本。代码变为汇编语言。
+ 汇编as：s->o，文本->二进制。汇编语言变为机器语言。
+ 链接ld：o->exe，二进制->二进制。加入printf其他目标文件。

## 编译系统作用

+ 优化程序性能。
+ 理解链接错误。
+ 避免安全漏洞。

## 执行内存命令

通过shell。如果不是内置shell命令就默认是文件名。输入`./hello`，就开始运行hello.c程序，然后输出hello,world。

### 系统硬件结构

+ 总线：传输定长信息字到各个部件。
+ I/O设备：通过控制器（设备或系统的主印制电路板）/适配器（插在主板上的卡）与总线相连传递数据。一般有输入设备的键盘、鼠标，输出设备的显示器，存储数据的磁盘。
+ 主存：临时存储数据。是一组动态随机存取存储器DRAM芯片组成；是一个线性字节数组，有唯一数组索引。
+ 处理器CPU：解释处理主存指令。加载、存储、操作、跳转。

### 运行hello程序

+ 输入->键盘->USB控制器->I/O总线->I/O桥->总线接口->寄存器文件->系统总线->I/O桥->内存总线->主存储器：shell程序接收./hello字符串，然后将其读入寄存器，最后存放到内存中。
+ I/O桥->I/O总线->磁盘控制器->磁盘数据->I/O总线->I/O桥->内存总线->主存储器：shell程序加载hello文件，将代码数据从磁盘复制到主存中。
+ 主存储器->内存总线->I/O桥->系统总线->总线接口->寄存器文件->总线接口->系统总线->I/O桥->I/O总线->图形适配器->显示器：执行main程序，将打印字符串hello,world从主存复制到寄存器文件，再复制到显示设备，并显示出来。

## 高速缓存

hello程序运行时会进行大量的复制操作，如./hello字符串和hello,world字符。

为了减少无用复制操作，并弥补主存处理器速度差异，出现了高速缓存存储器，用于保存常用数据。一般使用静态随机访问存储器SRAM实现。

## 存储结构

+ 寄存器。
+ L1高速缓存（SRAM）。
+ L2高速缓存（SRAM）。
+ L3高速缓存（SRAM）。
+ 主存（DRAM）。
+ 本地二级存储（本地磁盘）。
+ 远程二级存储（分布式文件系统、Web服务器）。

## 操作系统管理硬件

操作系统功能：

+ 控制软件使用硬件。
+ 提供软件操作硬件的简单一致机制。

操作系统对硬件抽象表示：

+ 进程->主存、处理器、I/O设备。
+ 虚拟内存->主存、磁盘I/O设备。
+ 文件->I/O设备。

### 进程

+ 进程：运行程序的抽象。
+ 并发：一个进程指令和另一个进程指令交错进行。
+ 上下文：操作系统所保存的跟踪进程运行所需所有状态信息，包括PC、寄存器值、主存值。
+ 上下文切换：操作系统将控制权转移到其他进程。需要保存当前上下文，恢复新进程上下文，转移控制权。
+ 内核：操作系统代码常驻主存的部分。不是一个独立进程，而是系统管理全部进程所用代码和数据结构的集合。

### 线程

+ 进程由线程组成。
+ 每个线程在进程上下文中，共享同样代码和全局数据。

### 虚拟内存

使得每个进程能近乎独占使用主存，每个进程所使用的内存是一致的。

地址从小到大：

+ 只读的程序代码和数据：从固定地址开始，接着是C语言全局变量对应的数据。最开始被指定大小。
+ 运行时堆：通过malloc和free函数动态拓展和收缩。
+ 共享库：存放共享的库的代码和数据。比如C标准库和数学库。
+ 用户栈：实现函数调用，在程序执行时可以动态拓展和收缩。
+ 内核虚拟内存：地址空间顶部，不允许程序读写内容活直接调用内核代码定义函数，只能调用内核来执行。

### 文件

字节序列。

## 网络通信

远程执行hello程序：

键盘->本地telnet客户端->远程telnet服务器->本地telnet客户端->屏幕。

## 重要主题

### Amdahl定律

对系统的部分进行优化时，对系统整体性能的优化取决于该部分重要性与优化程度。

系统执行某程序时间为To，某部分所需执行时间与总时间比例为a，该部分性能提升比例为k，即该部分原先所需时间为aTo，现在所需时间为(aTo)/k，总执行时间为Tn=(1-a)/To+(aTo)/k=To[(1-a)+a/k]。从而加速比S=To/Tn=1/[(1-a)+a/k]。

### 并发和并行

+ 线程级并发。
+ 指令级并发。
+ 单指令多数据并行。

### 抽象

文件、虚拟内存、进程、虚拟机（整个计算机，包括操作系统、处理器、程序）。
